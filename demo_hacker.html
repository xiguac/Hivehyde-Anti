<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HiveHyde - HIGH RISK User Simulation</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 20px; line-height: 1.6; color: #333; background-color: #fff0f0; }
        h1 { color: #d93025; }
        h3 { color: #1a1a1a; }
        .container { max-width: 800px; margin: 0 auto; }
        .interactive-area { margin-bottom: 20px; display: flex; align-items: center; }
        input[type="text"] { padding: 10px; font-size: 16px; width: 350px; margin-right: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; border: none; border-radius: 4px; background-color: #d93025; color: white; transition: background-color 0.2s; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        button:hover:not(:disabled) { background-color: #a52714; }
        pre { background-color: #f5f5f5; padding: 15px; border-radius: 5px; white-space: pre-wrap; word-wrap: break-word; border: 1px solid #eee; font-family: "Courier New", Courier, monospace; }
        .status { font-weight: bold; }
        .status.success { color: #28a745; }
        .status.error { color: #dc3545; }
        .warning { background-color: #fdf8e2; border: 1px solid #ffc107; padding: 10px; border-radius: 4px; margin-bottom: 20px;}
    </style>
</head>
<body>

    <div class="container">
        <h1>HiveHyde - 高危用户模拟器</h1>
        <div class="warning">
            <b>警告:</b> 这个页面会主动篡改你的浏览器环境来模拟一个自动化工具。这仅用于测试目的。
        </div>
        <ol>
            <li><b>环境已篡改:</b> `navigator.webdriver` 已被设置为 `true`。</li>
            <li><b>模拟机器行为:</b> 请不要移动鼠标，直接点击下方的“提交”按钮。</li>
        </ol>
        <p><b>系统状态:</b> <span id="status" class="status">正在初始化...</span></p>

        <div class="interactive-area">
            <input type="text" id="dataInput" placeholder="输入一些内容..." disabled>
            <button id="submitBtn" disabled>提交 (等待初始化)</button>
        </div>

        <h3>控制台输出结果预览:</h3>
        <pre id="resultPreview">等待初始化完成...</pre>
    </div>

    <!-- ✨ 核心修改 1: 在所有脚本加载前，先执行环境篡改脚本 -->
    <script>
        console.warn('[模拟器] 正在执行环境篡改...');
        try {
            // --- 模拟 Puppeteer/Playwright 等自动化工具环境 ---
            // 目标: 触发 anomalyData.webdriver 规则 (+50分)
            Object.defineProperty(navigator, 'webdriver', {
                get: () => true,
                configurable: true // 让tampering检测也能发现
            });
            console.log(`[模拟器] navigator.webdriver 已设置为: ${navigator.webdriver}`);

            // --- （可选）模拟堆栈关键字 ---
            // 这是一个更高级的模拟，可以在Error原型上注入一个假的stack getter
            // 以确保能触发 stack:contains_keyword (+40分)
            // 但仅设置webdriver=true就足以达到高危目的，所以这里暂时注释掉以保持简洁
            /*
            const originalError = Error;
            Error = function(...args) {
                const instance = new originalError(...args);
                Object.defineProperty(instance, 'stack', {
                    get: function() {
                        return 'Error: Fake error from puppeteer script\n    at eval (puppeteer_evaluation_script:1:1)';
                    }
                });
                return instance;
            };
            console.log('[模拟器] Error.prototype.stack 已被篡改以包含 "puppeteer" 关键字。');
            */
            
        } catch (e) {
            console.error('[模拟器] 环境篡改失败:', e);
        }
        console.warn('[模拟器] 环境篡改完成。');
    </script>

    <!-- 1. 引入外部依赖库 -->
    <script src="./crypto-js.min.js"></script>
    
    <!-- 2. 按顺序引入 HiveHyde 系统模块 -->
    <!-- (这部分保持不变) -->
    <script src="./session_vault.js"></script>
    <script src="./data_loom.js"></script>
    <script src="./anomaly_scan.js"></script>
    <script src="./risk_matrix.js"></script>
    <script src="./core_engine.js"></script>

    <!-- 3. 应用逻辑与初始化 -->
    <!-- ✨ 核心修改 2: 移除对鼠标移动的要求，并增加注释说明 -->
    <script>
        // --- 模拟后端API ---
        // (这部分保持不变)
        const originalFetch = window.fetch;
        window.fetch = function(url, options) {
            if (url.includes('/warden/init')) {
                console.log('%c[模拟后端] 拦截到 /warden/init 请求，返回模拟的密钥和令牌...', 'color: blue');
                const mockResponse = { code: 0, data: { key: "a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2", token: "mock-session-token-" + Date.now() + "-" + Math.random().toString(16).slice(2) }, msg: "操作成功" };
                return Promise.resolve({ ok: true, status: 200, json: () => Promise.resolve(mockResponse) });
            }
            return originalFetch(url, options);
        };

        // --- 应用初始化 ---
        // (这部分保持不变)
        async function main() {
            const statusEl = document.getElementById('status');
            const submitBtn = document.getElementById('submitBtn');
            const dataInput = document.getElementById('dataInput');
            const resultPreview = document.getElementById('resultPreview');

            try {
                await window.HiveHyde.initialize({ apiBaseUrl: 'http://api.mock.server' });
                statusEl.textContent = '初始化成功！';
                statusEl.className = 'status success';
                submitBtn.textContent = '提交';
                submitBtn.disabled = false;
                dataInput.disabled = false;
                resultPreview.textContent = '准备就绪，请直接点击提交按钮以模拟机器人行为。';
            } catch (error) {
                statusEl.textContent = `初始化失败: ${error.message}`;
                statusEl.className = 'status error';
                resultPreview.textContent = `错误详情:\n${error.stack}`;
                return;
            }

            // 绑定按钮点击事件
            submitBtn.addEventListener('click', async () => {
                const inputValue = dataInput.value;
                console.clear();
                console.log(`%c[用户操作] 按钮被点击，输入内容为: "${inputValue}"`, 'color: red'); // 颜色改为红色以示区别
                console.log('%c--------------------------------------------------', 'color: gray');
                
                resultPreview.textContent = '正在计算，请稍候...';
                submitBtn.disabled = true;
                submitBtn.textContent = '计算中...';

                const apiUrl = '/api/v1/submit_data';
                const params = { content: inputValue, source: 'high_risk_demo', timestamp: new Date().toISOString() };
                const method = 'POST';

                console.log('[HiveHyde] 调用 processRequest 开始处理...');
                const hiveAntiResult = await window.HiveHyde.processRequest(apiUrl, params, method);

                console.log('%c[HiveHyde] 计算完成！结果如下：', 'font-weight: bold; color: purple;');
                console.log(hiveAntiResult);

                resultPreview.textContent = JSON.stringify(hiveAntiResult, null, 2);
                submitBtn.disabled = false;
                submitBtn.textContent = '提交';
            });
        }

        document.addEventListener('DOMContentLoaded', main);
    </script>

</body>
</html>