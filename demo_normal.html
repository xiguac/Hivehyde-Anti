<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HiveHyde Anti-Crawler Demo</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 20px; line-height: 1.6; color: #333; }
        h1, h3 { color: #1a1a1a; }
        .container { max-width: 800px; margin: 0 auto; }
        .interactive-area { margin-bottom: 20px; display: flex; align-items: center; }
        input[type="text"] { padding: 10px; font-size: 16px; width: 350px; margin-right: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; border: none; border-radius: 4px; background-color: #007bff; color: white; transition: background-color 0.2s; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        button:hover:not(:disabled) { background-color: #0056b3; }
        pre { background-color: #f5f5f5; padding: 15px; border-radius: 5px; white-space: pre-wrap; word-wrap: break-word; border: 1px solid #eee; font-family: "Courier New", Courier, monospace; }
        .status { font-weight: bold; }
        .status.success { color: #28a745; }
        .status.error { color: #dc3545; }
    </style>
</head>
<body>

    <div class="container">
        <h1>HiveHyde Anti-Crawler Demo</h1>
        <p>这是一个用于测试和演示 `hiveHyde_anti` 系统的交互页面</p>
        <ol>
            <li>在页面上随意移动和点击鼠标，以生成行为数据。</li>
            <li>在下方输入框中输入任意内容，然后点击“提交”按钮。</li>
        </ol>
        <p><b>系统状态:</b> <span id="status" class="status">正在初始化...</span></p>

        <div class="interactive-area">
            <input type="text" id="dataInput" placeholder="输入一些内容..." disabled>
            <!-- 这是一个蜜罐(Honeypot)字段，爬虫可能会自动填充它 -->
            <input type="text" name="confirm_email" style="display: none;">
            <button id="submitBtn" disabled>提交 (等待初始化)</button>
        </div>

        <h3>控制台输出结果预览:</h3>
        <pre id="resultPreview">等待初始化完成...</pre>
    </div>

    <!-- 1. 引入外部依赖库 -->
    <script src="./crypto-js.min.js"></script>
    
    <!-- 2. 按顺序引入 HiveHyde 系统模块 -->
    <script src="./session_vault.js"></script>
    <script src="./data_loom.js"></script>
    <script src="./anomaly_scan.js"></script>
    <script src="./risk_matrix.js"></script>
    <script src="./core_engine.js"></script>
    <!-- api_sentinel.js 是用于集成axios的，在这个纯粹的demo中不需要 -->

    <!-- 3. 应用逻辑与初始化 -->
    <script>
        // --- 模拟后端API ---
        // 我们通过拦截 window.fetch 来模拟一个假的后端接口
        // 这样我们的 session_vault.js 不需要做任何修改就能工作
        const originalFetch = window.fetch;
        window.fetch = function(url, options) {
            // 只拦截我们的密钥获取接口
            if (url.includes('/warden/init')) {
                console.log('%c[模拟后端] 拦截到 /warden/init 请求，返回模拟的密钥和令牌...', 'color: blue');
                
                // 模拟一个符合后端规范的成功响应
                const mockResponse = {
                    code: 0,
                    data: {
                        key: "a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2", // 模拟一个64位的密钥
                        token: "mock-session-token-" + Date.now() + "-" + Math.random().toString(16).slice(2)
                    },
                    msg: "操作成功"
                };

                return Promise.resolve({
                    ok: true,
                    status: 200,
                    json: () => Promise.resolve(mockResponse)
                });
            }
            // 其他所有请求，都正常放行 (虽然这个demo里没有其他请求)
            return originalFetch(url, options);
        };

        // --- 应用初始化 ---
        async function main() {
            const statusEl = document.getElementById('status');
            const submitBtn = document.getElementById('submitBtn');
            const dataInput = document.getElementById('dataInput');
            const resultPreview = document.getElementById('resultPreview');

            try {
                // 初始化 HiveHyde 系统，并传入后端API的基地址
                await window.HiveHyde.initialize({
                    apiBaseUrl: 'http://api.mock.server' // 在这个demo里，这个地址会被我们的fetch拦截，所以可以是任意合法的URL
                });

                statusEl.textContent = '初始化成功！';
                statusEl.className = 'status success';
                submitBtn.textContent = '提交';
                submitBtn.disabled = false;
                dataInput.disabled = false;
                resultPreview.textContent = '准备就绪，请点击提交按钮。';

            } catch (error) {
                statusEl.textContent = `初始化失败: ${error.message}`;
                statusEl.className = 'status error';
                resultPreview.textContent = `错误详情:\n${error.stack}`;
                return;
            }

            // 绑定按钮点击事件
            submitBtn.addEventListener('click', async () => {
                const inputValue = dataInput.value;
                console.clear();
                console.log(`%c[用户操作] 按钮被点击，输入内容为: "${inputValue}"`, 'color: green');
                console.log('%c--------------------------------------------------', 'color: gray');
                
                resultPreview.textContent = '正在计算，请稍候...';
                submitBtn.disabled = true;
                submitBtn.textContent = '计算中...';

                // 模拟一个POST请求
                const apiUrl = '/api/v1/submit_data';
                const params = {
                    content: inputValue,
                    source: 'demo_page',
                    timestamp: new Date().toISOString()
                };
                const method = 'POST';

                console.log('[HiveHyde] 调用 processRequest 开始处理...');

                // 调用 HiveHyde 核心处理函数
                const hiveAntiResult = await window.HiveHyde.processRequest(apiUrl, params, method);

                console.log('%c[HiveHyde] 计算完成！结果如下：', 'font-weight: bold; color: purple;');
                console.log(hiveAntiResult);

                // 在页面上展示结果
                resultPreview.textContent = JSON.stringify(hiveAntiResult, null, 2);

                submitBtn.disabled = false;
                submitBtn.textContent = '提交';
            });
        }

        // 启动应用
        document.addEventListener('DOMContentLoaded', main);

    </script>

</body>
</html>